#GPLv3 Raif Sarcich 2011

import wx

from events import *
from listwidgets import *
from piedb.objectstore import *
#from baselistpanel import BaseListPanel # <-- todo


class BaseListPanel(wx.Panel):
    '''Basic class for displaying and working with "results"'''

    def __init__(self, parent, id=-1, style=wx.EXPAND|wx.TAB_TRAVERSAL):
        wx.Panel.__init__(self, parent, id=id, style=style)
        self._do_layout()
        self._do_bindings()

    def AddObjects(self, ostore):
        self.ListDisplay.DeleteAllItems()
        self.objectstore = ostore
        for i in self.objectstore.GetNext():
            self.ListDisplay.AddObject(i)

    def AddObject(self, obj):
        ref = self.objectstore.Add(obj)
        self.ListDisplay.AddObject(obj, ref)

    # def AddObject(self, obj):
    #     '''Add an object to the list (and object store)'''
    #     print 'BaseListPanel: AddObject: not implemented'

    # def AddObjects(self, objlist):
    #     '''Populate list with new data in the form of an object store'''
    #     print 'BaseListPanel: AddObjects: not implemented'''

    def GetSelectedItem(self):
        '''Return the currently selected object'''
        print 'BaseListPanel: GetSelectedItem: not implemented'


class WebListPanel(BaseListPanel):
    '''Class for working with web scrapes'''
    objectstore = SimplePieObjectStore()
    
    def _do_layout(self):
        self.sizer0 = wx.BoxSizer(wx.VERTICAL)
        self.ListDisplay = WebListCtrl(self)
        self.sizer0.Add(self.ListDisplay, 1, wx.ALL|wx.EXPAND, 5)
        self.SetSizer(self.sizer0)
        self.Layout()

    def _do_bindings(self):
        pass

class FileListPanel(BaseListPanel):
    objectstore = SimplePieObjectStore()

    def _do_layout(self):
        self.sizer0 = wx.BoxSizer(wx.VERTICAL)
        self.ListDisplay = FileListCtrl(self)
        self.sizer0.Add(self.ListDisplay, 1, wx.ALL|wx.EXPAND, 5)
        self.SetSizer(self.sizer0)
        self.Layout()

    def _do_bindings(self):
        pass

class BibListPanel(BaseListPanel):
    '''Class for displaying and working with bibliographic data'''
    objectstore = SimplePieObjectStore()

    def _do_layout(self):
        self.sizer0 = wx.BoxSizer(wx.VERTICAL)
        self.sizer1 = wx.BoxSizer(wx.HORIZONTAL)

        self.ListDisplay = BibListCtrl(self)
        self.DelButton = wx.Button(self, -1, label=_("Delete"))
        self.sizer1.Add(self.DelButton, 1, wx.ALL, 5)
        self.sizer0.Add(self.ListDisplay, 1, wx.ALL|wx.EXPAND, 5)
        self.sizer0.Add(self.sizer1)
        self.SetSizer(self.sizer0)
        self.Layout()

    def _do_bindings(self):
        self.ListDisplay.Bind(wx.EVT_LIST_ITEM_ACTIVATED, 
                              self.onSelectionActivated)
        self.ListDisplay.Bind(wx.EVT_LIST_ITEM_SELECTED,
                              self.onSelectionChanged)
        self.DelButton.Bind(wx.EVT_BUTTON,
                            self.onDeleteItem)

    def onSelectionChanged(self, evt):
        # print 'BibListPanel.onSelectionChanged'
        # print 'Item index:', evt.GetIndex()
        # print 'Item data:', self.ListDisplay.GetItemData(evt.GetIndex())
        self.ListDisplay.onItemSelected(evt)
        ref = self.ListDisplay.GetItemData(evt.GetIndex())
        newevt = PieListSelectionEvent(
            ref=ref, 
            pieobject=self.objectstore.GetByCollectionIndex(ref))
        wx.PostEvent(self, newevt)

    def onSelectionActivated(self, evt):
        print 'BibListPanel.onSelectionActivated'
        print 'Item index:', evt.GetIndex()
        print 'Item data:', self.ListDisplay.GetItemData(evt.GetIndex())
        print 'Object by index:', self.objectstore.GetByCollectionIndex(self.ListDisplay.GetItemData(evt.GetIndex()))

    def onDeleteItem(self, evt):
        print self.GetSelectedItem()

    def GetSelectedItem(self):
        return self.objectstore[self.ListDisplay.currentitem]

